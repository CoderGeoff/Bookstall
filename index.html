<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<style id='generate-style-inline-css'>
body{line-height:32px;font-size:18px;margin:30px;color:#222222;font-family:Merriweather, serif;}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
</head>
<body>
<p id=outcome>Please wait while your transaction is being handled - don't refresh the page!</p>
<script>
"use strict";

$(document).ready(function(){
    updateStock();
});

function updateStock() {
console.log("History.state : ", history.state);
const pageParameters = new URLSearchParams(window.location.search);
const outcomeElement = $("#outcome");

if (pageParameters.has("item") && pageParameters.has("uniqueid") && pageParameters.has("price") && pageParameters.has("key")) {
    var outcome = "Sorry, the transaction failed. Please try again.";
    
	const item = pageParameters.get("item");
	const uniqueid = pageParameters.get("uniqueid");
	const price = pageParameters.get("price"); 
	const key = { applicationAccessKey: pageParameters.get("key") };

	// do this early -> fail before sending the url
	const pathname = window.location.pathname;
	const lastIndexOfSlash = pathname.lastIndexOf("/");
	const pathroot = lastIndexOfSlash > -1 ? pathname.slice(0, lastIndexOfSlash) : "";
	const successUrl = /*window.location.protocol + window.location.hostname + '/' + pathroot + */ "outcome.html?text=Confirmed:%20" + item + "%20at%20Â£" + price + ".";
	
	const postBody = JSON.stringify({
		Action: "Add",
		Rows: [{ItemId: uniqueid, Amount: price }]
		});
	
	const url = "https://api.appsheet.com/api/v2/apps/f4a568db-d53d-4192-893d-d441950dfc61/tables/Transactions/Action";
	const r = $.ajax({
		url: url,
		method: "POST",
		headers: key,
		data: postBody,
		contentType: "application/json",
		success: function (result) {
			console.log("Success"); 
			const addedRowsText = JSON.stringify(result); 
			console.log(addedRowsText);
			if (addedRowsText.includes(uniqueid))  {
				// all ok; replace to prevent reloading
				window.location.replace(successUrl);
			}
			else {
				outcomeElement.text("Internal error");
			}
		},
		error: function(request, errorDescription, exception) {
			console.log("Error");
			outcome = "<p>" + outcome + "<br/>Details: " + r.responseText + "</p>";
			console.log(outcome);
			outcomeElement.html(outcome);
		}
	});	
} else {
    outcomeElement.text("Invalid request.");
}
}
</script>
</body>

